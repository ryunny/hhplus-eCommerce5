# E-Commerce ERD (Entity Relationship Diagram)

## ğŸ“Š í…Œì´ë¸” ê´€ê³„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     users       â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ PK id           â”‚
â”‚    name         â”‚
â”‚    email (UK)   â”‚
â”‚    phone        â”‚
â”‚    balance      â”‚
â”‚    created_at   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                            â”‚
         â–¼                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   cart_items    â”‚                          â”‚     orders      â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ PK id           â”‚                          â”‚ PK id           â”‚
â”‚ FK user_id      â”‚                          â”‚ FK user_id      â”‚
â”‚ FK product_id   â”‚                          â”‚ FK user_coupon  â”‚
â”‚    quantity     â”‚                          â”‚    recipient    â”‚
â”‚    created_at   â”‚                          â”‚    address      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚    phone        â”‚
         â”‚                                   â”‚    total_amount â”‚
         â”‚                                   â”‚    discount     â”‚
         â”‚                                   â”‚    final_amount â”‚
         â”‚                                   â”‚    status       â”‚
         â”‚                                   â”‚    created_at   â”‚
         â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                            â”‚
         â”‚                                            â”‚ 1:N
         â”‚                                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                            â”‚                  â”‚
         â”‚                                            â–¼                  â–¼
         â”‚                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                   â”‚  order_items    â”‚ â”‚    payments     â”‚
         â”‚                                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                                   â”‚ PK id           â”‚ â”‚ PK id           â”‚
         â”‚                                   â”‚ FK order_id     â”‚ â”‚ FK order_id     â”‚
         â”‚                                   â”‚ FK product_id   â”‚ â”‚    paid_amount  â”‚
         â”‚                                   â”‚    quantity     â”‚ â”‚    status       â”‚
         â”‚                                   â”‚    unit_price   â”‚ â”‚    data_trans   â”‚
         â”‚                                   â”‚    subtotal     â”‚ â”‚    created_at   â”‚
         â”‚                                   â”‚    created_at   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
         â”‚                                            â”‚                  â”‚
         â”‚                                            â”‚                  â”‚ 1:1
         â–¼                                            â”‚                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   categories    â”‚                                  â”‚         â”‚    refunds      â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                  â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ PK id           â”‚                                  â”‚         â”‚ PK id           â”‚
â”‚    name         â”‚                                  â”‚         â”‚ FK order_id     â”‚
â”‚    created_at   â”‚                                  â”‚         â”‚    refund_amt   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚         â”‚    reason       â”‚
         â”‚                                            â”‚         â”‚    status       â”‚
         â”‚ 1:N                                        â”‚         â”‚    created_at   â”‚
         â–¼                                            â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚    products     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ PK id           â”‚
â”‚ FK category_id  â”‚
â”‚    name         â”‚
â”‚    description  â”‚
â”‚    price        â”‚
â”‚    stock        â”‚
â”‚    created_at   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²
         â”‚
         â”‚ N:M (through user_coupons)
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     coupons     â”‚        â”‚  user_coupons   â”‚        â”‚  coupon_queues  â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ PK id           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”‚ PK id           â”‚        â”‚ PK id           â”‚
â”‚    name         â”‚  1:N   â”‚ FK user_id      â”‚        â”‚ FK user_id      â”‚
â”‚    type         â”‚        â”‚ FK coupon_id    â”‚        â”‚ FK coupon_id    â”‚
â”‚    disc_rate    â”‚        â”‚    status       â”‚        â”‚    status       â”‚
â”‚    disc_amount  â”‚        â”‚    issued_at    â”‚        â”‚    queue_pos    â”‚
â”‚    min_order    â”‚        â”‚    expires_at   â”‚        â”‚    processed_at â”‚
â”‚    total_qty    â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚    failed_reasonâ”‚
â”‚    issued_qty   â”‚                 â”‚                 â”‚    created_at   â”‚
â”‚    start_date   â”‚                 â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚    end_date     â”‚                 â”‚
â”‚    use_queue    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
                                    â””â”€â”€â–º FK in orders table
```

## ğŸ“‹ í…Œì´ë¸” ìƒì„¸ ì„¤ëª…

### 1. users (ì‚¬ìš©ì)
- **ì„¤ëª…**: íšŒì› ì •ë³´ ë° ì”ì•¡ ê´€ë¦¬
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `balance`: í¬ì¸íŠ¸/ì”ì•¡ (ì› ë‹¨ìœ„)
- **ì œì•½ ì¡°ê±´**:
  - `email`: UNIQUE
  - `balance >= 0` (ìŒìˆ˜ ë¶ˆê°€)

### 2. categories (ì¹´í…Œê³ ë¦¬)
- **ì„¤ëª…**: ìƒí’ˆ ë¶„ë¥˜
- **ê´€ê³„**: 1:N â†’ products

### 3. products (ìƒí’ˆ)
- **ì„¤ëª…**: íŒë§¤ ìƒí’ˆ ì •ë³´
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `price`: ê°€ê²© (ì› ë‹¨ìœ„)
  - `stock`: ì¬ê³  ìˆ˜ëŸ‰
- **ì œì•½ ì¡°ê±´**:
  - `price > 0`
  - `stock >= 0`
- **ê´€ê³„**:
  - N:1 â†’ categories
  - 1:N â†’ order_items, cart_items

### 4. coupons (ì¿ í°)
- **ì„¤ëª…**: í• ì¸ ì¿ í° ë§ˆìŠ¤í„°
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `coupon_type`: RATE(í• ì¸ìœ¨) | AMOUNT(ì •ì•¡ í• ì¸)
  - `discount_rate`: í• ì¸ìœ¨ (%)
  - `discount_amount`: í• ì¸ ê¸ˆì•¡ (ì›)
  - `total_quantity`: ì´ ë°œê¸‰ ê°€ëŠ¥ ìˆ˜ëŸ‰
  - `issued_quantity`: ë°œê¸‰ëœ ìˆ˜ëŸ‰
  - `use_queue`: ëŒ€ê¸°ì—´ ì‚¬ìš© ì—¬ë¶€
- **ì œì•½ ì¡°ê±´**:
  - `issued_quantity <= total_quantity`
- **ê´€ê³„**: 1:N â†’ user_coupons, coupon_queues

### 5. user_coupons (ì‚¬ìš©ì ì¿ í°)
- **ì„¤ëª…**: ì‚¬ìš©ìê°€ ë°œê¸‰ë°›ì€ ì¿ í°
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `status`: UNUSED | USED | EXPIRED
  - `expires_at`: ë§Œë£Œì¼
- **ê´€ê³„**:
  - N:1 â†’ users
  - N:1 â†’ coupons
  - 1:1 â†’ orders (optional)

### 6. orders (ì£¼ë¬¸)
- **ì„¤ëª…**: ì£¼ë¬¸ ì •ë³´
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `total_amount`: ì´ ì£¼ë¬¸ ê¸ˆì•¡
  - `discount_amount`: í• ì¸ ê¸ˆì•¡
  - `final_amount`: ìµœì¢… ê²°ì œ ê¸ˆì•¡
  - `status`: PENDING | PAID | CANCELLED
- **ê´€ê³„**:
  - N:1 â†’ users
  - N:1 â†’ user_coupons (optional)
  - 1:N â†’ order_items, payments, refunds

### 7. order_items (ì£¼ë¬¸ ì•„ì´í…œ)
- **ì„¤ëª…**: ì£¼ë¬¸ ìƒì„¸ (ì¥ë°”êµ¬ë‹ˆ ë‚´ì—­)
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `quantity`: ì£¼ë¬¸ ìˆ˜ëŸ‰
  - `unit_price`: ë‹¨ê°€ (ì£¼ë¬¸ ì‹œì  ê°€ê²©)
  - `subtotal`: ì†Œê³„
- **ì œì•½ ì¡°ê±´**:
  - `quantity > 0`
- **ê´€ê³„**:
  - N:1 â†’ orders
  - N:1 â†’ products

### 8. payments (ê²°ì œ)
- **ì„¤ëª…**: ê²°ì œ ì •ë³´ ë° ì™¸ë¶€ ë°ì´í„° ì „ì†¡ ìƒíƒœ
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `status`: PENDING | COMPLETED | FAILED | CANCELLED
  - `data_transmission_status`: PENDING | SUCCESS | FAILED
- **ê´€ê³„**: N:1 â†’ orders

### 9. refunds (í™˜ë¶ˆ)
- **ì„¤ëª…**: í™˜ë¶ˆ ìš”ì²­ ë° ì²˜ë¦¬
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `status`: REQUESTED | APPROVED | REJECTED | COMPLETED
- **ê´€ê³„**: N:1 â†’ orders

### 10. cart_items (ì¥ë°”êµ¬ë‹ˆ)
- **ì„¤ëª…**: ì‚¬ìš©ìì˜ ì¥ë°”êµ¬ë‹ˆ
- **ì œì•½ ì¡°ê±´**:
  - UNIQUE(user_id, product_id): ì‚¬ìš©ìë‹¹ ìƒí’ˆ ì¤‘ë³µ ë°©ì§€
  - `quantity > 0`
- **ê´€ê³„**:
  - N:1 â†’ users
  - N:1 â†’ products

### 11. coupon_queues (ì¿ í° ëŒ€ê¸°ì—´)
- **ì„¤ëª…**: ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ ëŒ€ê¸°ì—´
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `status`: WAITING | PROCESSING | COMPLETED | FAILED
  - `queue_position`: ëŒ€ê¸° ìˆœë²ˆ
  - `processed_at`: ì²˜ë¦¬ ì™„ë£Œ ì‹œê°„
  - `failed_reason`: ì‹¤íŒ¨ ì‚¬ìœ 
- **ê´€ê³„**:
  - N:1 â†’ users
  - N:1 â†’ coupons

## ğŸ”‘ ì£¼ìš” ì¸ë±ìŠ¤

### ì¡°íšŒ ì„±ëŠ¥ ìµœì í™”
```sql
-- ì‚¬ìš©ìë³„ ìµœê·¼ ì£¼ë¬¸ ì¡°íšŒ
idx_orders_user_created (user_id, created_at DESC)

-- ì¸ê¸° ìƒí’ˆ í†µê³„ (ìµœê·¼ 3ì¼)
idx_order_items_created_product (created_at DESC, product_id)

-- ì¿ í° ë°œê¸‰ ê°€ëŠ¥ ì—¬ë¶€
idx_coupons_date_quantity (start_date, end_date, issued_quantity, total_quantity)

-- ì‚¬ìš©ìì˜ ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í°
idx_user_coupons_user_status (user_id, status)

-- ì¿ í° ëŒ€ê¸°ì—´ ì²˜ë¦¬
idx_coupon_queues_coupon_status (coupon_id, status)
```

## ğŸ’¡ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

### ì£¼ë¬¸ í”„ë¡œì„¸ìŠ¤
1. **ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°**: cart_items í…Œì´ë¸”ì— ì¶”ê°€
2. **ì£¼ë¬¸ ìƒì„±**: orders í…Œì´ë¸” INSERT
3. **ì£¼ë¬¸ ì•„ì´í…œ ìƒì„±**: order_items í…Œì´ë¸” INSERT (Nê°œ)
4. **ì¬ê³  ì°¨ê°**: products.stock -= quantity (ë¹„ê´€ì  ë½)
5. **ì¿ í° ì‚¬ìš©**: user_coupons.status = 'USED'
6. **ì”ì•¡ ì°¨ê°**: users.balance -= final_amount (ë¹„ê´€ì  ë½)
7. **ê²°ì œ ìƒì„±**: payments í…Œì´ë¸” INSERT
8. **ì£¼ë¬¸ ìƒíƒœ ë³€ê²½**: orders.status = 'PAID'
9. **ë°ì´í„° ì „ì†¡**: payments.data_transmission_status ì—…ë°ì´íŠ¸

### ì¿ í° ë°œê¸‰ í”„ë¡œì„¸ìŠ¤
- **ì¼ë°˜ ì¿ í° (use_queue=false)**:
  1. coupons.issued_quantity ì¦ê°€
  2. user_coupons í…Œì´ë¸” INSERT

- **ì„ ì°©ìˆœ ì¿ í° (use_queue=true)**:
  1. coupon_queues í…Œì´ë¸” INSERT (status=WAITING)
  2. ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ìˆœì°¨ ì²˜ë¦¬
  3. ë°œê¸‰ ì™„ë£Œ ì‹œ user_coupons INSERT + status=COMPLETED

### ë™ì‹œì„± ì œì–´ (DB ì „í™˜ ì‹œ)
- **ì¬ê³  ì°¨ê°**: `SELECT ... FOR UPDATE` (products)
- **ì”ì•¡ ì°¨ê°**: `SELECT ... FOR UPDATE` (users)
- **ì¿ í° ë°œê¸‰**: `SELECT ... FOR UPDATE` (coupons)

## ğŸ“Š ë°ì´í„° ë¬´ê²°ì„±

### CHECK ì œì•½ ì¡°ê±´
```sql
users.balance >= 0           -- ì”ì•¡ ìŒìˆ˜ ë¶ˆê°€
products.stock >= 0          -- ì¬ê³  ìŒìˆ˜ ë¶ˆê°€
products.price > 0           -- ê°€ê²© ì–‘ìˆ˜ë§Œ í—ˆìš©
order_items.quantity > 0     -- ìˆ˜ëŸ‰ ì–‘ìˆ˜ë§Œ í—ˆìš©
coupons.issued_quantity <= total_quantity  -- ë°œê¸‰ëŸ‰ ì´ˆê³¼ ë¶ˆê°€
```

### UNIQUE ì œì•½ ì¡°ê±´
```sql
users.email                  -- ì´ë©”ì¼ ì¤‘ë³µ ë¶ˆê°€
cart_items (user_id, product_id)  -- ì¥ë°”êµ¬ë‹ˆ ìƒí’ˆ ì¤‘ë³µ ë¶ˆê°€
```

## ğŸ¯ í™•ì¥ ê³ ë ¤ì‚¬í•­

### 1. ìƒ¤ë”© ì „ëµ
- **users**: user_id ê¸°ì¤€ ìƒ¤ë”©
- **orders**: user_id ê¸°ì¤€ ìƒ¤ë”© (ê°™ì€ ì‚¬ìš©ì ë°ì´í„°ëŠ” ê°™ì€ ìƒ¤ë“œ)
- **products**: category_id ê¸°ì¤€ ìƒ¤ë”©

### 2. íŒŒí‹°ì…”ë‹
- **orders**: created_at ê¸°ì¤€ ì›”ë³„ íŒŒí‹°ì…”ë‹
- **order_items**: created_at ê¸°ì¤€ ì›”ë³„ íŒŒí‹°ì…”ë‹
- **payments**: created_at ê¸°ì¤€ ì›”ë³„ íŒŒí‹°ì…”ë‹

### 3. ì½ê¸° ì „ìš© ë³µì œë³¸
- í†µê³„/ì¡°íšŒ ì¿¼ë¦¬ëŠ” Slave DBë¡œ ë¶„ì‚°
- ì£¼ë¬¸ ìƒì„±ì€ Master DB

### 4. ìºì‹±
- **ìƒí’ˆ ì •ë³´**: Redis ìºì‹± (TTL: 1ì‹œê°„)
- **ì¹´í…Œê³ ë¦¬**: Redis ìºì‹± (TTL: 1ì¼)
- **ì¸ê¸° ìƒí’ˆ**: Redis Sorted Set (ì‹¤ì‹œê°„ ê°±ì‹ )
